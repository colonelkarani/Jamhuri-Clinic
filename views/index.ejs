<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Health Tracker Dashboard ‚Äî Improved</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Basic reset & variables */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
            --primary:#0066cc; --primary-dark:#0052a3; --accent:#00d9ff;
            --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
            --bg-light:#f8fafc; --bg-white:#ffffff; --text-dark:#1e293b;
            --text-gray:#64748b; --border:#e2e8f0; --card-radius:12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --glass: rgba(255,255,255,0.6);
        }
        body{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, #f4f7fb 0%, var(--bg-light) 100%);
            color:var(--text-dark);
            min-height:100vh;
            overflow:hidden;
            -webkit-font-smoothing:antialiased;
        }

        /* Layout */
        .container { display:flex; height:100vh; }
        .sidebar {
            width:300px; background:linear-gradient(180deg,var(--primary),var(--primary-dark)); color:#fff;
            display:flex; flex-direction:column; transition:width .25s ease; position:relative; z-index:1000;
            box-shadow:2px 0 10px rgba(0,0,0,0.08);
        }
        .sidebar.collapsed{ width:84px; }
        .sidebar * { -webkit-tap-highlight-color: transparent; }

        .sidebar-header{ padding:18px; display:flex; align-items:center; justify-content:space-between; gap:8px; border-bottom:1px solid rgba(255,255,255,0.06);}
        .brand{ font-weight:700; font-size:16px; overflow:hidden; white-space:nowrap; }
        .sidebar.collapsed .brand { display:none; }

        .sidebar-toggle{ background:none;border:none;color:#241941;cursor:pointer;font-size:20px; width:42px;height:42px;border-radius:8px; display:flex;align-items:center;justify-content:center; }
        .sidebar-toggle:focus{ outline:3px solid rgba(255,255,255,0.12); }

        .user-profile{ padding:18px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,0.06); }
        .user-avatar{ width:48px;height:48px;border-radius:50%; background:var(--accent); display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary); flex-shrink:0;}
        .user-info{ overflow:hidden; }
        .sidebar.collapsed .user-info{ display:none; }

        .nav-menu{ flex:1; overflow:auto; padding:12px 6px; }
        .nav-section{ margin-bottom:18px; }
        .nav-section-title{ font-size:11px; font-weight:700; text-transform:uppercase; opacity:0.6; padding:0 12px; margin-bottom:8px; letter-spacing:0.6px; }
        .sidebar.collapsed .nav-section-title{ display:none; }

        .nav-item{
            display:flex; align-items:center; gap:12px; padding:10px 12px; cursor:pointer; border-radius:8px; transition:all .18s ease;
            color:rgba(255,255,255,0.88); font-size:14px; text-align:left; background:none; border:none; width:100%;
        }
        .nav-item:hover{ background: rgba(255,255,255,0.06); color:#fff; transform:translateX(2px); }
        .nav-item.active{ background:var(--accent); color:var(--primary); font-weight:600; box-shadow: 0 6px 14px rgba(0,102,204,0.12); }
        .nav-icon{ font-size:18px; min-width:24px; flex-shrink:0; text-align:center; }
        .nav-label{ flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .sidebar.collapsed .nav-label{ display:none; }

        /* Main Content */
        .main-content{ flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .header{
            background:var(--bg-white); padding:18px 26px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow);
        }
        .header-left{ display:flex; gap:18px; align-items:center; }
        .header-title{ font-size:20px; font-weight:700; }
        .header-time{ font-size:13px; color:var(--text-gray); }
        .header-actions{ display:flex; gap:10px; align-items:center; }
        .search-input{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--bg-light); min-width:220px;}
        .search-input:focus{ outline:none; box-shadow:0 0 0 3px rgba(0,102,204,0.08); border-color:var(--primary); }

        .content{ flex:1; overflow:auto; padding:26px; }

        /* Page system */
        .page{ display:none; animation:fadeIn .18s ease both; }
        .page.active{ display:block; }
        @keyframes fadeIn{ from{ opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }

        /* Greeting */
        .greeting-section{ background:var(--bg-white); padding:26px; border-radius:var(--card-radius); margin-bottom:22px; box-shadow:var(--shadow); border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
        .greeting-text{ font-size:22px; font-weight:700; }
        .greeting-date{ color:var(--text-gray); font-size:13px; }

        /* Grid & Cards */
        .grid{ display:grid; gap:18px; margin-bottom:24px; }
        .grid-2{ grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
        .grid-3{ grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); }
        .card{ background:var(--bg-white); padding:18px; border-radius:var(--card-radius); box-shadow:var(--shadow); border:1px solid var(--border); }
        .metric-card{ padding:18px; border-radius:var(--card-radius); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
        .metric-label{ font-size:12px; opacity:0.9; font-weight:700; text-transform:uppercase; letter-spacing:0.6px; }
        .metric-value{ font-size:28px; font-weight:800; margin:6px 0; }
        .metric-unit{ font-size:14px; opacity:0.9; margin-left:6px; }
        .metric-avg{ font-size:12px; opacity:1; margin-top:8px; color: #fffdfd; }

        /* Charts */
        .chart-container{ position:relative; height:320px; margin-bottom:10px; }

        /* Forms */
        .form-section{ background:var(--bg-white); padding:18px; border-radius:var(--card-radius); box-shadow:var(--shadow); border:1px solid var(--border); }
        .form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:14px; margin-bottom:12px; }
        .form-group{ margin-bottom:10px; }
        .form-label{ display:block; font-weight:600; margin-bottom:6px; font-size:13px; color:var(--text-dark); }
        .form-input{ width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:14px; }
        .form-input:focus{ outline:none; box-shadow:0 0 0 3px rgba(0,102,204,0.06); border-color:var(--primary); }

        /* Appointment list */
        .appointment-item{ padding:16px; border-left:4px solid var(--primary); margin-bottom:14px; background:linear-gradient(to right, rgba(0,102,204,0.03), transparent); border-radius:6px; transition:all .18s ease; }
        .appointment-item:hover{ box-shadow:0 8px 30px rgba(0,0,0,0.06); transform:translateY(-2px); }
        .appointment-title{ font-weight:700; font-size:15px; margin-bottom:6px; }
        .appointment-doctor{ color:var(--text-gray); font-size:13px; margin-bottom:8px; }
        .appointment-status{ display:inline-block; padding:6px 10px; border-radius:18px; font-size:12px; font-weight:700; text-transform:uppercase; }
        .status-confirmed{ background: rgba(16,185,129,0.12); color:var(--success); }
        .status-pending{ background: rgba(245,158,11,0.12); color:var(--warning); }
        .appointment-details{ font-size:13px; color:var(--text-gray); line-height:1.5; }

        /* Toggle */
        .toggle-switch{ position:relative; width:50px; height:26px; background:#ddd; border-radius:999px; cursor:pointer; transition:background .18s ease; }
        .toggle-switch::after{ content:''; position:absolute; left:2px; top:2px; width:22px; height:22px; background:white; border-radius:50%; transition:left .18s ease; }
        .toggle-switch.active{ background:var(--success); }
        .toggle-switch.active::after{ left:26px; }

        /* Buttons */
        .btn{ padding:10px 14px; border-radius:10px; border:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:700; font-size:13px; }
        .btn-primary{ background:var(--primary); color:#fff; box-shadow:0 6px 18px rgba(0,102,204,0.14); }
        .btn-primary:hover{ background:var(--primary-dark); }
        .btn-secondary{ background:var(--bg-light); border:1px solid var(--border); color:var(--text-dark); }

        /* Toasts */
        .toast-wrap{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:10px; z-index:3000; }
        .toast{ background:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12); border:1px solid var(--border); min-width:220px; font-weight:600; color:var(--text-dark); display:flex; gap:10px; align-items:center; }

        /* Modal */
        .modal-backdrop{ position:fixed; inset:0; background:rgba(16,24,40,0.5); display:none; align-items:center; justify-content:center; z-index:4000; padding:20px; }
        .modal-backdrop.active{ display:flex; }
        .modal{ width:100%; max-width:720px; background:var(--bg-white); border-radius:14px; overflow:auto; max-height:90vh; padding:18px; border:1px solid var(--border); box-shadow:0 20px 60px rgba(0,0,0,0.3);}
        .modal-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .modal-title{ font-weight:800; font-size:18px; }

        /* Accessible focus & keyboard */
        :focus{ outline:3px solid rgba(0,102,204,0.12); outline-offset:2px; border-radius:6px; }

        /* Footer / small */
        .small{ font-size:12px; color:rgb(0, 0, 0); }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar{ position:fixed; height:100vh; left:0; top:0; transform:translateX(0); }
            .sidebar.collapsed{ transform:translateX(-100%); }
            .content{ padding:18px; }
            .chart-container{ height:260px; }
            .header-time{ display:none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" aria-label="Primary Navigation">
            <div class="sidebar-header">
                <div class="brand" aria-hidden="true">Health Tracker</div>
            </div>

<% function getInitials(fullName) {
  // Trim any leading/trailing whitespace and split the name by spaces
  const nameParts = fullName.trim().split(' ');

  let initials = '';

  // Get the first initial from the first name part
  if (nameParts.length > 0 && nameParts[0].length > 0) {
    initials += nameParts[0][0].toUpperCase();
  }

  // If there's more than one name part (i.e., a last name exists), get its initial
  if (nameParts.length > 1 && nameParts[nameParts.length - 1].length > 0) {
    initials += nameParts[nameParts.length - 1][0].toUpperCase();
  }

  return initials;
} %>

            <div class="user-profile" role="region" aria-label="User profile">
                <div class="user-avatar" aria-hidden="true"><%= getInitials(name)%></div>
                <div class="user-info">
                    <div class="user-name"><%= name %></div>
                    <div class="user-email "><%= email %></div>
                </div>
            </div>

            <nav class="nav-menu" role="navigation" aria-label="Main menu" id="navMenu">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <button class="nav-item active" data-page="dashboard" role="link" aria-current="page"><span class="nav-icon">üìä</span><span class="nav-label">Dashboard</span></button>
                    <button class="nav-item" data-page="overview" role="link"><span class="nav-icon">üëÅÔ∏è</span><span class="nav-label">Overview</span></button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Health</div>
                    <button class="nav-item" data-page="vitals" role="link"><span class="nav-icon">‚ù§Ô∏è</span><span class="nav-label">Vitals</span></button>
                    <button class="nav-item" data-page="blood-sugar" role="link"><span class="nav-icon">ü©∏</span><span class="nav-label">Blood Sugar</span></button>
                    <button class="nav-item" data-page="trends" role="link"><span class="nav-icon">üìà</span><span class="nav-label">Trends</span></button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Medical</div>
                    <button class="nav-item" data-page="appointments" role="link"><span class="nav-icon">üìÖ</span><span class="nav-label">Appointments</span></button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <button class="nav-item" data-page="profile" role="link"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
                    <button class="nav-item" data-page="settings" role="link"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span></button>
                </div>

                
            </nav>
        </aside>

        <!-- Main content -->
        <main class="main-content" id="mainContent">
            <header class="header" role="banner">
                <div class="header-left">
                <button id="sidebarToggle" class="sidebar-toggle" aria-pressed="false" aria-label="Toggle sidebar">‚ò∞</button>

                    <div class="header-title" id="pageTitle">Dashboard</div>
                </div>
                <div class="header-actions">
                    <input id="globalSearch" class="search-input" placeholder="Search appointments or vitals..." aria-label="Global search"/>
                    <button id="exportCSV" class="btn btn-secondary" title="Export vitals">‚¨á Export CSV</button>
                    <button id="newAppointmentBtn" class="btn btn-primary" title="Create appointment">Ôºã Appointment</button>
                </div>
            </header>

            <section class="content" id="contentArea">
                <!-- Dashboard -->
                <section id="dashboard" class="page active" aria-labelledby="pageTitle">
                    <div class="greeting-section" role="region" aria-label="Greeting">
                        <div>
                            <div class="greeting-text" id="greeting">Good morning, <%= name.split(" ")[0] %>! üëã</div>
                            <div class="greeting-date small" id="greetingDate" style="color: #1e293b;"></div>
                        </div>
                        
                    </div>

                    <h2 style="margin-bottom:12px; font-size:18px">Your Health Metrics</h2>
                    <div class="grid grid-2" id="metricsGrid">
                        <div class="metric-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                            <div class="metric-label">Heart Rate</div>
                            <div class="metric-value" id="metricHeart">72<span class="metric-unit"> bpm</span></div>
                            <div class="metric-avg small" id="metricHeartAvg">Avg: ‚Äî</div>
                        </div>
                        <div class="metric-card" id="metricSugarCard" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="metric-label">Blood Sugar</div>
                            <div class="metric-value" id="metricSugar">5.3<span class="metric-unit"> mmol/L</span></div>
                            <div class="metric-avg small" id="metricSugarAvg">Avg: ‚Äî</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <div class="metric-label">Systolic BP</div>
                            <div class="metric-value" id="metricSys">118<span class="metric-unit"> mmHg</span></div>
                            <div class="metric-avg small" id="metricSysAvg">Avg: ‚Äî</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <div class="metric-label">Diastolic BP</div>
                            <div class="metric-value" id="metricDia">78<span class="metric-unit"> mmHg</span></div>
                            <div class="metric-avg small" id="metricDiaAvg">Avg: ‚Äî</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <div class="metric-label">Weight</div>
                            <div class="metric-value" id="metricWeight">79.4<span class="metric-unit"> kg</span></div>
                            <div class="metric-avg small" id="metricWeightAvg">Avg: ‚Äî</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:14px;">
                        <button class="btn btn-primary" id="gotoVitals">üìù Record Vitals</button>
                        <button class="btn btn-primary" id="gotoAppointments">üìÖ View Appointments</button>
                        <button class="btn btn-primary" id="gotoTrends">üìà View Trends</button>
                    </div>
                </section>

                <!-- Overview -->
                <section id="overview" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:16px; font-size:18px">Health Overview</h1>
                    <div class="grid grid-2">
                        <div class="card">
                            <h3 style="margin-bottom:12px">Status Summary</h3>
                            <p class="small" id="overviewSummary">‚Äî</p>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:12px">Recommendations</h3>
                            <ul style="margin-left:16px; color:var(--text-gray)">
                                <li>üíß Increase water intake</li>
                                <li>üèÉ Engage in at least 30 minutes of activity daily</li>
                                <li>üçΩÔ∏è Monitor post-meal sugar.</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Vitals -->
                <section id="vitals" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:16px; font-size:18px">Record Your Vitals</h1>
                    <div class="form-section" style="max-width:760px;">
                        <form id="vitalsForm" aria-label="Record vitals"method="POST" action="/vitals">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="heartRate">Heart Rate (bpm)</label>
                                    <input id="inpHeart" type="number" name="heartRate"  class="form-input" min="30" max="220" placeholder="e.g., 72" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="bloodSugar">Blood Sugar (mmol/L)</label>
                                    <input id="inpSugar" type="number" name="bloodSugar" step="0.1" class="form-input" min="2" max="25" placeholder="e.g., 5.3" >
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="systolicBp">Systolic BP (mmHg)</label>
                                    <input id="inpSys" type="number" name="systolicBp" class="form-input" min="70" max="260" placeholder="e.g., 118" >
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="diastolicBp">Diastolic BP (mmHg)</label>
                                    <input id="inpDia" type="number" name="diastolicBp" class="form-input" min="40" max="160" placeholder="e.g., 78" >
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="weight">Weight (kg)</label>
                                    <input id="inpWeight" type="number" name="weight" step="0.1" class="form-input" min="20" max="300" placeholder="e.g., 79.4" >
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="date">Date</label>
                                    <input id="inpDate" type="date" name="date" class="form-input" required/>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="time">Time</label>
                                    <input id="inpTime" type="time" name="time" class="form-input" required/>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button type="submit" class="btn btn-primary">‚úì Record Vitals</button>
                                <button type="button" id="showVitalsHistory" class="btn btn-secondary">View History</button>
                                <a 
                                onclick="window.open('https:/www.hopkinsmedicine.org/health/conditions-and-diseases/vital-signs-body-temperature-pulse-rate-respiration-rate-blood-pressure')"
                                class="small" style="margin-left:auto; color:var(--text-gray);cursor: pointer;">How to record vitals </a>
                            </div>
                        </form>
                    </div>

                    <div id="vitalsHistoryWrapper" style="margin-top:18px;"></div>
                </section>

                <!-- Blood sugar -->
                <section id="blood-sugar" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:16px; font-size:18px">Blood Sugar Tracking</h1>
                    <div class="grid grid-2">
                        <div class="card">
                            <h3 style="margin-bottom:12px">Current Level</h3>
                            <div class="metric-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width:fit-content;">
                                <div class="metric-label">Blood Sugar Level</div>
                                <div class="metric-value" id="currentSugar">5.3<span class="metric-unit"> mmol/L</span></div>
                                <div class="metric-avg small" id="currentSugarStatus">Status: Optimal ‚úì</div>
                            </div>
                        </div>
                        <div class="card">
                            <form method="post" action="/blood-sugar" id="bloodSugarForm">
                            <h3 style="margin-bottom:12px">Quick Log</h3>
                            <div class="form-group">
                                <label class="form-label" for="quickSugar">Blood Sugar Reading (mmol/L)</label>
                                <input id="quickSugar" type="number" name="bloodSugar" step="0.1" class="form-input" min="2" max="25" placeholder="e.g., 5.3">
                            </div>
                            <div class="form-group">
                                    <label class="form-label" for="date">Date</label>
                                    <input id="inpDate" type="date" name="date" class="form-input" required/>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="time">Time</label>
                                    <input id="inpTime" type="time" name="time" class="form-input" required/>
                                </div>
                            <div style="display:flex; gap:8px;">
                                <button id="logQuickSugar" class="btn btn-primary">Log Reading</button>
                                <button id="clearSugarLogs" class="btn btn-secondary">Clear</button>
                            </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Trends -->
                <section id="trends" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:16px; font-size:18px">Health Trends</h1>
                        <div style="font-weight:700; margin-bottom: 8px;">Time range:</div>
                        <select id="trendRange" class="form-input" style="max-width:160px; margin-bottom: 8px;">
                            <option value="7">7 days</option>
                            <option value="14">14 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                            <option value="0">All</option>
                        </select>

                   
                    <div class="charts-grid" style="display:grid; gap:18px; grid-template-columns: repeat(auto-fit,minmax(360px,1fr));">
                        <div class="card">
                            <h3 style="margin-bottom:12px">Weight Trend </h3>
                            <div class="chart-container"><canvas id="weightChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:12px">Blood Sugar Trend </h3>
                            <div class="chart-container"><canvas id="sugarChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:12px">Heart Rate Trend </h3>
                            <div class="chart-container"><canvas id="heartChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:12px">Blood Pressure Trend </h3>
                            <div class="chart-container"><canvas id="bpChart"></canvas></div>
                        </div>
                    </div>
                </section>

                <!-- Appointments -->
                <section id="appointments" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:12px; font-size:18px">Your Appointments</h1>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                        <button class="btn btn-primary" id="newApptBtnTop">+ New Appointment</button>
                        <input id="apptSearch" class="search-input" placeholder="Search appointments..." aria-label="Search appointments"/>
                        <button id="clearAppts" class="btn btn-secondary">Clear All</button>
                    </div>

                    <div id="appointmentsList" class="card">
                        <!-- Dynamic appointment items -->
                    </div>
                </section>

                <!-- Profile -->
                <section id="profile" class="page" aria-hidden="true">
                    <div class="profile-header card" style="display:flex; gap:18px; align-items:center;">
                        <div class="profile-avatar"><%= getInitials(name)%></div>
                        <div class="profile-info">
                            <h2 style="margin-bottom:4px"><%= name %></h2>
                            <p class="small">üìß <%= email %></p>
                        </div>

                    </div>


<form action="/update-profile" method="post">

                    <div class="card" style="margin-top:16px;">
                        
                        <h3 style="margin-bottom:12px">Personal Information</h3>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input id="profileName" type="text" name="name" class="form-input"  value="<%= name %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input id="profileEmail" type="email" class="form-input" readonly value="<%= email %>">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profilePhone">Phone Number</label>
                            <input id="profilePhone" name="phone" type="tel" class="form-input" placeholder="+254 7XX XXX XXX" maxlength="20" value="<%= phone %>">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profileHeight">Height</label>
                            <div style="display:flex; gap:8px;">
                                <input id="profileHeight" name="height" type="number" step="0.1" class="form-input" placeholder="e.g., 175" style="max-width:160px;" aria-label="Height in cm" value="<%= height%>">
                                <div style="align-self:center; color:var(--text-gray);">cm</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profileBloodType">Blood Type</label>
                            <select id="profileBloodType" name="bloodType" class="form-input">
                                <option value="" selected>Select blood type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                            <div class="form-label" style="color: red;" for="profileBloodType"> <%= bloodType|| '' %></div>

                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profileAllergies">Allergies</label>
                            <textarea id="profileAllergies" name="allergies" class="form-input" rows="2" placeholder="List any allergies (e.g., penicillin, peanuts)"><%= allergies || '' %></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profileChronic">Health Conditions</label>
                            <textarea id="profileChronic" name="chronicConditions" class="form-input" rows="2" placeholder="e.g., asthma, diabetes"><%= chronicConditions || '' %></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profilePhysician">Primary Physician</label>
                            <input id="profilePhysician" name="primaryPhysician" type="text" class="form-input" placeholder="Doctor's name / clinic" value="<%= primaryPhysician || '' %>">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="profilePhysicianPhone">Physician Contact</label>
                            <input id="profilePhysicianPhone" name="physicianPhone" type="tel" class="form-input" placeholder="+254 7XX XXX XXX" value="<%= physicianPhone || '' %>">
                        </div>

                        <div class="form-group" style="display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:start;">
                            <div>
                                <label class="form-label" for="emergencyName">Emergency Contact Name</label>
                                <input id="emergencyName" name="emergencyName" type="text" class="form-input" placeholder="Full name" value="<%= emergencyName || '' %>">
                            </div>
                            <div>
                                <label class="form-label" for="emergencyRelation">Relation</label>
                                <input id="emergencyRelation" name="emergencyRelation" type="text" class="form-input" placeholder="e.g., Spouse" value="<%= emergencyRelation || '' %>">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="emergencyPhone">Emergency Contact Phone</label>
                            <input id="emergencyPhone" name="emergencyPhone" type="tel" class="form-input" placeholder="+254 7XX XXX XXX" value="<%= emergencyPhone || '' %>">
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button id="saveProfile" class="btn btn-primary">Save Changes</button>
                        </div>
                    </div>
                    </form>
                </section>

                <!-- Settings -->
                <section id="settings" class="page" aria-hidden="true">
                    <h1 style="margin-bottom:16px; font-size:18px">Settings</h1>
                    <div class="card" style="margin-bottom:12px;">
                        <h3 style="margin-bottom:12px">Notifications</h3>
                        <div class="settings-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                            <div>
                                <strong>Email Notifications</strong>
                                <p class="small" style="margin-top:6px">Receive health updates via email</p>
                            </div>
                            <div id="emailNotif" class="toggle-switch active" role="switch" aria-checked="true" tabindex="0"></div>
                        </div>

                        <div class="settings-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                            <div>
                                <strong>Appointment Reminders</strong>
                                <p class="small" style="margin-top:6px">Get reminded before appointments</p>
                            </div>
                            <div id="apptReminders" class="toggle-switch active" role="switch" aria-checked="true" tabindex="0"></div>
                        </div>

                        <div class="settings-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                            <div>
                                <strong>Daily Health Summary</strong>
                                <p class="small" style="margin-top:6px">Receive daily health insights</p>
                            </div>
                            <div id="dailySummary" class="toggle-switch" role="switch" aria-checked="false" tabindex="0"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom:12px">Privacy & Security</h3>
                        <div class="settings-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                            <div>
                                <strong>Two-Factor Authentication</strong>
                                <p class="small" style="margin-top:6px">Enhance account security</p>
                            </div>
                            <div id="twoFA" class="toggle-switch" role="switch" aria-checked="false" tabindex="0"></div>
                        </div>
                        <div class="settings-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                            <div>
                                <strong>Share Health Data</strong>
                                <p class="small" style="margin-top:6px">Allow healthcare providers to access your data</p>
                            </div>
                            <div id="shareData" class="toggle-switch active" role="switch" aria-checked="true" tabindex="0"></div>
                        </div>
                        <div style="margin-top:12px; display:flex; gap:8px;">
                            <button id="resetData" class="btn btn-secondary">Reset Local Data</button>
                            <button id="exportAll" class="btn btn-primary">Export All</button>
                            <button id="deleteAccount" onclick="deleteAccount()" class="btn btn-primary" style="background-color: red;">Delete Account</button>
                        </div>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <!-- Modal: Create Appointment -->
    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document" aria-labelledby="modalTitle">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Appointment</div>
                <button id="closeModal" class="btn btn-secondary" aria-label="Close">‚úï</button>
            </div>
            <div style="margin-top:12px;">
                <form id="appointmentForm" method="post" action="/user-appointments">
                    <div class="form-group">
                        <label class="form-label" for="apptTitle">Title</label>
                        <input id="apptTitle" name="title" class="form-input" type="text" placeholder="e.g., Annual Checkup" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="apptDoctor">Doctor / Department</label>
                        <input id="apptDoctor" name="drName" class="form-input" type="text" placeholder="e.g., Dr. George Maingi" required>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <div style="flex:1;">
                            <label class="form-label" for="apptDate">Date</label>
                            <input id="apptDate" name="date" class="form-input" type="date" required>
                        </div>
                        <div style="flex:1;">
                            <label class="form-label" for="apptTime">Time</label>
                            <input id="apptTime" name="time" class="form-input" type="time" required>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label class="form-label" for="apptNotes">Notes / Location</label>
                        <input id="apptNotes" name="notesOrLocation" class="form-input" type="text" placeholder="Room 305, Lab services...">
                    </div>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button type="submit" class="btn btn-primary">Save Appointment</button>
                        <button type="button" id="cancelAppt" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

    <script>
        // GitHub Copilot
        // Enhanced JS: navigation, persistence, charts, vitals history, appointments, CSV export, accessibility
let vitals;

async function loadVitalsHistory(userID, limit = 30) {
  try {
    const response = await fetch(`/api/vitals-history/${userID}`);
    if (!response.ok) throw new Error('Network response was not ok');
     vitals = await response.json();
    updateSummaryMetrics(vitals.slice(-limit))
    renderVitalsHistory(vitals.slice(-limit)); // Pass last `limit` entries to rendering function
  } catch (err) {
    console.error('Failed to load vitals:', err);
  }
}

// Call this function with the logged-in user's ID to populate the vitals table
loadVitalsHistory('<%=id %>');

        // Basic DOM refs
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const navItems = document.querySelectorAll('.nav-item');
        const pageTitle = document.getElementById('pageTitle');
        const pageNames = {
            'dashboard': 'Dashboard',
            'overview': 'Overview',
            'vitals': 'Record Vitals',
            'blood-sugar': 'Blood Sugar',
            'trends': 'Trends',
            'appointments': 'Appointments',
            'profile': 'Profile',
            'settings': 'Settings'
        };

        //collapse the navbar
        document.addEventListener('click', function(e) {
  // If sidebar is collapsed, do nothing
  if (sidebar.classList.contains('collapsed')) return;

  // If click is inside sidebar OR sidebar toggle button, ignore
  if (sidebar.contains(e.target) || sidebarToggle.contains(e.target)) return;

  // Otherwise, collapse the sidebar
  sidebar.classList.add('collapsed');
  sidebarToggle.setAttribute('aria-pressed', 'true');
});

        // Storage keys
        const LS_KEYS = {
            vitals: 'ht_vitals_v1',
            appointments: 'ht_appts_v1',
            settings: 'ht_settings_v1',
            profile: 'ht_profile_v1'
        };

        // Utilities
        function genId(){ return 'id_' + Math.random().toString(36).slice(2,9); }
        function showToast(text, timeout = 3500){
            const wrap = document.getElementById('toastWrap');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            wrap.appendChild(toast);
            setTimeout(()=> toast.style.opacity = '0.95', 50);
            setTimeout(()=> { toast.style.transform = 'translateY(8px)'; }, 50);
            setTimeout(()=> {
                toast.style.opacity = 0;
                setTimeout(()=> wrap.removeChild(toast), 400);
            }, timeout);
        }

        // Toggle sidebar
        sidebarToggle.addEventListener('click', () => {
            const collapsed = sidebar.classList.toggle('collapsed');
            sidebarToggle.setAttribute('aria-pressed', String(collapsed));
        });

        // Keyboard nav for sidebar (arrow keys)
        (function keyboardNav(){
            const items = Array.from(navItems);
            items.forEach((btn,i)=>{
                btn.tabIndex = 0;
                btn.addEventListener('keydown', (e)=>{
                    if(e.key === 'ArrowDown'){ e.preventDefault(); const next = items[(i+1)%items.length]; next.focus(); }
                    if(e.key === 'ArrowUp'){ e.preventDefault(); const prev = items[(i-1+items.length)%items.length]; prev.focus(); }
                    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
                });
            });
        })();

        // Nav click
        navItems.forEach(item=>{
            item.addEventListener('click', ()=> {
                const pageName = item.getAttribute('data-page');
                switchPage(pageName);
            });
        });

        function switchPage(pageName){
            navItems.forEach(item=>{
                item.classList.toggle('active', item.getAttribute('data-page') === pageName);
                if(item.getAttribute('data-page') === pageName){
                    item.setAttribute('aria-current','page');
                } else {
                    item.removeAttribute('aria-current');
                }
            });
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.setAttribute('aria-hidden','true');
            });
            const target = document.getElementById(pageName);
            if (!target) return;
            target.classList.add('active');
            target.setAttribute('aria-hidden','false');
            pageTitle.textContent = pageNames[pageName] || 'Page';
            if(pageName === 'trends'){
                setTimeout(initCharts, 120);
            }
            // update hash for navigation/back
            try { history.pushState({page:pageName}, '', '#'+pageName); } catch(e){}
        }

document.querySelectorAll('.metric-card').forEach(card=>{
    card.addEventListener("click", (e)=>{
        switchPage("vitals")
    })
})


        // Allow switchPage calls
        window.switchPage = switchPage;

        // Restore page from hash
        (function restoreFromHash(){
            const h = location.hash.replace('#','');
            if(h && document.getElementById(h)) switchPage(h);
        })();

        // Time & Greeting
        function updateTime(){
            const now = new Date();
            const options = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' };
            document.getElementById('greetingDate').textContent = now.toLocaleDateString('en-US', options);
            const hour = now.getHours();
            let greetingText = (hour < 12) ? 'Good morning' : (hour < 18) ? 'Good afternoon' : 'Good evening';
            document.getElementById('greeting').textContent = `${greetingText}, <%= name.split(" ")[0] %>! üëã`;
        }
        setInterval(updateTime, 60000);
        updateTime();

        // Local Storage helpers
        function load(key, fallback){
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : fallback;
            } catch(e) { return fallback; }
        }
        function save(key, data){
            try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){}
        }

        // Initialize persisted state
        let settings = load(LS_KEYS.settings, { emailNotif:true, apptReminders:true, dailySummary:false, shareData:true, twoFA:false });
        let profile =  { name:'<%= name %>', email:'<%= email %>' };

        // Update summary metrics shown on dashboard and averages
        function updateSummaryMetrics(vitals){
            if(!vitals || vitals.length === 0) return;
            const last = vitals[vitals.length-1];
            last.heart?  document.getElementById('metricHeart').innerHTML = `${last.heart}<span class="metric-unit"> bpm</span>`:document.getElementById('metricHeart').innerHTML = `Record`
            last.sugar?document.getElementById('metricSugar').innerHTML = `${last.sugar}<span class="metric-unit"> mmol/L</span>`:document.getElementById('metricSugar').innerHTML = `Record`
            last.sys?document.getElementById('metricSys').innerHTML = `${last.sys}<span class="metric-unit"> mmHg</span>`:document.getElementById('metricSys').innerHTML = `Record`
            last.dia?document.getElementById('metricDia').innerHTML = `${last.dia}<span class="metric-unit"> mmHg</span>`:document.getElementById('metricDia').innerHTML = `Record`
            last.weight?document.getElementById('metricWeight').innerHTML = `${last.weight}<span class="metric-unit"> kg</span>`:document.getElementById('metricWeight').innerHTML = `Record`
            // averages
            const avg = (key) => (vitals.reduce((s,i)=>s + (i[key]||0),0)/vitals.length).toFixed(key === 'weight' ? 1 : 1);
            document.getElementById('metricHeartAvg').textContent = `Avg: ${avg('heart')} bpm`;
            document.getElementById('metricSugarAvg').textContent = `Avg: ${avg('sugar')} mmol/L`;
            document.getElementById('metricSysAvg').textContent = `Avg: ${avg('sys')} mmHg`;
            document.getElementById('metricDiaAvg').textContent = `Avg: ${avg('dia')} mmHg`;
            document.getElementById('metricWeightAvg').textContent = `Avg: ${avg('weight')} kg`;
            document.getElementById('currentSugar').innerHTML = `${last.sugar}<span class="metric-unit"> mmol/L</span>`;
            // summary text
            let parts = [];

if (last.ts) {
  parts.push(`Last recorded ${new Date(last.ts).toLocaleString()}`);
}
if (last.heart !== undefined) {
  parts.push(`HR ${last.heart} bpm`);
}
if (last.sugar !== undefined) {
  parts.push(`Sugar ${last.sugar} mmol/L`);
}
if (last.sys !== undefined && last.dia !== undefined) {
  parts.push(`BP ${last.sys}/${last.dia} mmHg`);
}
if (last.weight !== undefined) {
  parts.push(`Weight ${last.weight} kg`);
}

document.getElementById('overviewSummary').textContent = parts.join(' ‚Ä¢ ');

        }

        updateSummaryMetrics(vitals);

        // Vitals form handling
        const vitalsForm = document.getElementById('vitalsForm');

        vitalsForm.addEventListener("submit", (e)=>{

const filteredFormData = new FormData(vitalsForm);
for (const [key, value] of formData.entries()) {
  if (value.trim() !== "") {
    filteredFormData.append(key, value);
  }
}

            fetch("/vitals", {body: filteredFormData, method: "POST"})
            .then(data=>{showToast('‚úÖ Vitals recorded successfully!')})
            .catch(err =>{showToast("Error recording data")})
              
            vitalsForm.reset();
        })

        // vitalsForm.addEventListener('submit', (e) => {
        //     e.preventDefault();
        //     const heart = Number(document.getElementById('inpHeart').value);
        //     const sugar = Number(document.getElementById('inpSugar').value);
        //     const sys = Number(document.getElementById('inpSys').value);
        //     const dia = Number(document.getElementById('inpDia').value);
        //     const weight = Number(document.getElementById('inpWeight').value);
        //     const record = { ts: Date.now(), heart, sugar, sys, dia, weight };
        //     vitals.push(record);
        //     save(LS_KEYS.vitals, vitals);
        //     updateSummaryMetrics();
        //     renderVitalsHistory();
        //     showToast('‚úÖ Vitals recorded successfully!');
        //     vitalsForm.reset();
        // });

        // Vitals history rendering (collapsible simple table)
        function renderVitalsHistory(vitals, limit = 30){

            const wrapper = document.getElementById('vitalsHistoryWrapper');
            wrapper.innerHTML = '';
            if(!vitals || vitals.length === 0) { wrapper.innerHTML = '<div class="card small">No vitals recorded yet.</div>'; return; }
            const card = document.createElement('div');
            card.className = 'card';
            const title = document.createElement('h3'); title.textContent = `Vitals History (${vitals.length})`; title.style.marginBottom = '12px';
            card.appendChild(title);

            const table = document.createElement('div');
            table.style.overflow = 'auto';
            table.style.maxHeight = '260px';
            table.style.paddingRight = '6px';
            vitals.slice(-limit).reverse().forEach(v => {
                const item = document.createElement('div');
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                item.style.padding = '10px 0';
                item.style.borderBottom = '1px dashed var(--border)';
                item.innerHTML = `
                    <div style="min-width:220px">
                        <div style="font-weight:700">${new Date(v.ts).toLocaleString()}</div>
                        ${v.heart ?? '-'} bpm ‚Ä¢ 
      ${v.sugar ?? '-'} mmol/L ‚Ä¢ 
      ${v.sys ?? '-'} / ${v.dia ?? '-'} mmHg ‚Ä¢ 
      ${v.weight ?? '-'} kg
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-secondary small" data-ts="${v.ts}" aria-label="Copy values">Copy</button>
                        <button class="btn btn-secondary small" data-delete="${v.ts}" aria-label="Delete entry">Delete</button>
                    </div>
                `;
                table.appendChild(item);
            });

            card.appendChild(table);
            wrapper.appendChild(card);

            // copy & delete handlers
            card.querySelectorAll('button[data-ts]').forEach(b => {
                b.addEventListener('click', (e) => {
                    const ts = +b.getAttribute('data-ts');
                    const record = vitals.find(x => x.ts === ts);
                    if(record){
                        navigator.clipboard?.writeText(JSON.stringify(record))?.then(()=> showToast('Copied vitals to clipboard'));
                    }
                });
            });
    card.querySelectorAll('button[data-delete]').forEach(b => {
  b.addEventListener('click', async () => {
    const ts = +b.getAttribute('data-delete');
    
    try {
      const response = await fetch(`/api/vitals/${ts}`, { method: 'DELETE' });
      if (!response.ok) throw new Error('Delete failed');

      // Remove from local vitals array only after successful backend deletion
      vitals = vitals.filter(x => x.ts !== ts);
      renderVitalsHistory(vitals, 30);
      updateSummaryMetrics(vitals);
      showToast('Deleted vitals entry.');
    } catch (error) {
      console.error('Failed to delete vitals:', error);
      showToast('Failed to delete vitals entry.');
    }
  });
});

        }




        // Show/hide history
        document.getElementById('showVitalsHistory').addEventListener('click', ()=>{
            const wrapper = document.getElementById('vitalsHistoryWrapper');
            if(wrapper.innerHTML.trim() === '') renderVitalsHistory();
            wrapper.scrollIntoView({behavior:'smooth', block:'start'});
        });

        // Quick sugar logging
        // document.getElementById('logQuickSugar').addEventListener('click', ()=>{
        //     const val = Number(document.getElementById('quickSugar').value);
        //     if(!val) return showToast('Please enter a value.');
        //     const rec = { ts: Date.now(), heart: vitals.length ? vitals[vitals.length-1].heart : 72, sugar: val, sys: vitals.length ? vitals[vitals.length-1].sys : 118, dia: vitals.length ? vitals[vitals.length-1].dia : 78, weight: vitals.length ? vitals[vitals.length-1].weight : 79.4 };
        //     vitals.push(rec);
        //     save(LS_KEYS.vitals, vitals);
        //     updateSummaryMetrics(vitals);
        //     showToast('Quick glucose logged');
        //     document.getElementById('quickSugar').value = '';
        // });

        document.getElementById('clearSugarLogs').addEventListener('click', ()=>{
            document.getElementById("bloodSugarForm").reset()
            showToast('Form cleared.');
        });

        // Appointment modal
        const modalBackdrop = document.getElementById('modalBackdrop');
        const newAppointmentBtn = document.getElementById('newAppointmentBtn');
        const newApptBtnTop = document.getElementById('newApptBtnTop');
        const closeModal = document.getElementById('closeModal');
        const cancelAppt = document.getElementById('cancelAppt');
        const appointmentForm = document.getElementById('appointmentForm');

        function openModal(){
            modalBackdrop.classList.add('active');
            modalBackdrop.setAttribute('aria-hidden','false');
            document.getElementById('apptTitle').focus();
        }
        function closeModalFn(){
            modalBackdrop.classList.remove('active');
            modalBackdrop.setAttribute('aria-hidden','true');
        }
        newAppointmentBtn.addEventListener('click', openModal);
        newApptBtnTop.addEventListener('click', openModal);
        closeModal.addEventListener('click', closeModalFn);
        cancelAppt.addEventListener('click', closeModalFn);
        modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModalFn(); });
        document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && modalBackdrop.classList.contains('active')) closeModalFn(); });

        // Save appointment
//         appointmentForm.addEventListener('submit', (e)=>{
//             e.preventDefault();

            
// const filteredFormData = new FormData(appointmentForm);
// for (const [key, value] of formData.entries()) {
//   if (value.trim() !== "") {
//     filteredFormData.append(key, value);
//   }
// }

//             fetch("/user-appointments", {body: filteredFormData, method: "POST"})
//             .then(data=>{showToast('‚úÖ Appointments recorded successfully!')})
//             .catch(err =>{showToast("Error recording data")})

//             const title = document.getElementById('apptTitle').value.trim();
//             const doctor = document.getElementById('apptDoctor').value.trim();
//             const date = document.getElementById('apptDate').value;
//             const time = document.getElementById('apptTime').value;
//             const notes = document.getElementById('apptNotes').value.trim();
//             if(!title || !date || !time) return showToast('Please fill title, date and time.');
//             const appt = { id: genId(), title, doctor, date, time, notes, status: 'pending' };
//             appointments.push(appt);
//             save(LS_KEYS.appointments, appointments);
//             renderAppointments();
//             closeModalFn();
//             showToast('Appointment saved');
//             appointmentForm.reset();
//         });

        // Render appointments list
        function renderAppointments(appointments, filter = ''){
            const list = document.getElementById('appointmentsList');
            list.innerHTML = '';
            if(!appointments || appointments.length===0) { list.innerHTML = '<div class="small">No appointments scheduled.</div>'; return; }
            const wrapper = document.createElement('div');
            appointments.filter(a => {
                if(!filter) return true;
                const date = new Date( a.date)
                const dateString = date.toLocaleDateString(); // e.g., "11/5/2025"
const timeString = date.toLocaleTimeString(); // e.g., "2:08:00 PM"
                const term = filter.toLowerCase();
                return [a.title,a.drName,a.notesOrLocation,dateString,timeString].join(' ').toLowerCase().includes(term);
            }).forEach(a => {
                const date = new Date(a.date)
                const dateString = date.toLocaleDateString(); // e.g., "11/5/2025"
const timeString = date.toLocaleTimeString([], {
  hour: '2-digit',
  minute: '2-digit'
}); // e.g., "2:08:00 PM"
                const item = document.createElement('div');
                item.className = 'appointment-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="appointment-title">${a.title}</div>
                            <div class="appointment-doctor">${a.drName || '‚Äî'}</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-secondary small" data-action="delete" data-id="${a._id}">Delete</button>
                        </div>
                    </div>
                    <div style="margin-top:8px" class="appointment-details">
                        üìÖ ${dateString} ‚Ä¢ ${timeString} <br> üìç ${a.notesOrLocation || '‚Äî'}
                    </div>
                `;
                wrapper.appendChild(item);
            });

            list.appendChild(wrapper);

            // actions
            list.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', async()=> {
                    const action = btn.getAttribute('data-action');
                    if(action === 'delete'){
                        if(confirm('Delete appointment?')) {
                            const idToDelete = btn.getAttribute('data-id');
      if (!idToDelete) return;
                        try {
        const response = await fetch(`/api/appointments/${idToDelete}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Delete failed');

        // Update local appointments by removing the deleted one
        appointments = appointments.filter(appointment => appointment.id !== idToDelete);

        showToast('Deleted appointment entry.');
        console.log(`Deleted appointment with id: ${idToDelete}`);
setTimeout(() => {
loadAppointments('<%=id %>');
}, 2000);

        
      } catch (error) {
        showToast('Failed to delete appointment entry.');
        console.error('Error deleting appointment:', error);
      }

                            renderAppointments(appointments);
                        }
                    } 
                });
            });
        }

        async function loadAppointments(userID, limit = 30) {
  try {
    const response = await fetch(`/api/appointments/${userID}`);
    if (!response.ok) throw new Error('Network response was not ok');
    const appointments = await response.json();
        renderAppointments(appointments);
    
} catch (err) {
    console.error('Failed to load appointments:', err);
  }
}

// Call this function with the logged-in user's ID to populate the vitals table
loadAppointments('<%=id %>');

        // Appointment search
        document.getElementById('apptSearch').addEventListener('input', (e) => renderAppointments(e.target.value.trim()));

        // If editing an appointment, handle update
        // appointmentForm.addEventListener('submit', (e)=>{
        //     // handled above; add edit handling:
        //     const editId = appointmentForm.dataset.editId;
        //     if(editId){
        //         // update existing rather than create new
        //         const title = document.getElementById('apptTitle').value.trim();
        //         const doctor = document.getElementById('apptDoctor').value.trim();
        //         const date = document.getElementById('apptDate').value;
        //         const time = document.getElementById('apptTime').value;
        //         const notes = document.getElementById('apptNotes').value.trim();
        //         const idx = appointments.findIndex(a => a.id === editId);
        //         if(idx > -1){
        //             appointments[idx] = { ...appointments[idx], title, doctor, date, time, notes };
        //             save(LS_KEYS.appointments, appointments);
        //             renderAppointments();
        //             showToast('Appointment updated');
        //         }
        //         appointmentForm.reset();
        //         delete appointmentForm.dataset.editId;
        //         closeModalFn();
        //     }
        // });

        // Clear all appointments
        // document.getElementById('clearAppts').addEventListener('click', ()=>{
        //     if(confirm('Clear all appointments?')) {
        //         appointments = [];
        //         save(LS_KEYS.appointments, appointments);
        //         renderAppointments();
        //         showToast('All appointments removed');
        //     }
        // });

        // Profile save
        // document.getElementById('saveProfile').addEventListener('click', ()=>{
        //     profile.name = document.getElementById('profileName').value.trim();
        //     profile.email = document.getElementById('profileEmail').value.trim();
        //     save(LS_KEYS.profile, profile);
        //     showToast('Profile updated');
        // });

        // Settings toggles
        function bindToggle(id, key){
            const el = document.getElementById(id);
            el.classList.toggle('active', !!settings[key]);
            el.setAttribute('aria-checked', String(!!settings[key]));
            el.addEventListener('click', () => {
                settings[key] = !settings[key];
                el.classList.toggle('active', settings[key]);
                el.setAttribute('aria-checked', String(settings[key]));
                save(LS_KEYS.settings, settings);
                showToast('Settings updated');
            });
            el.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); }
            });
        }
        bindToggle('emailNotif','emailNotif');
        bindToggle('apptReminders','apptReminders');
        bindToggle('dailySummary','dailySummary');
        bindToggle('twoFA','twoFA');
        bindToggle('shareData','shareData');

        // Sync & export
    
        document.getElementById('exportCSV').addEventListener('click', ()=> {
            if(!vitals.length) return showToast('No vitals to export');
            const csv = [
                ['timestamp','heart','sugar','systolic','diastolic','weight'],
                ...vitals.map(v => [new Date(v.ts).toISOString(), v.heart, v.sugar, v.sys, v.dia, v.weight])
            ].map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'vitals_export.csv'; document.body.appendChild(a); a.click();
            setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 5000);
            showToast('Export started');
        });

        document.getElementById('exportAll').addEventListener('click', ()=> {
            const data = { vitals, appointments, settings, profile };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'health_dump.json'; document.body.appendChild(a); a.click();
            setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 5000);
            showToast('Export started');
        });

        // Reset local data
        document.getElementById('resetData').addEventListener('click', ()=>{
            if(!confirm('Reset all local data? This will clear vitals, appointments and settings.')) return;
            localStorage.removeItem(LS_KEYS.vitals);
            localStorage.removeItem(LS_KEYS.appointments);
            localStorage.removeItem(LS_KEYS.settings);
            localStorage.removeItem(LS_KEYS.profile);
            vitals = sampleVitals.slice();
            appointments = sampleAppointments.slice();
            settings = { emailNotif:true, apptReminders:true, dailySummary:false, shareData:true, twoFA:false };
            profile = { name:'<%= name %>', email:'<%= email %>' };
            save(LS_KEYS.vitals, vitals);
            save(LS_KEYS.appointments, appointments);
            save(LS_KEYS.settings, settings);
            save(LS_KEYS.profile, profile);
            renderAppointments();
            updateSummaryMetrics(vitals);
            showToast('Local data reset');
        });

      

        // Global search quick filter: search appointments & vitals
        // document.getElementById('globalSearch').addEventListener('keydown', (e)=>{
        //     if(e.key === 'Enter'){
        //         const term = e.target.value.trim().toLowerCase();
        //         if(term){
        //             // switch to appointments and filter
        //             switchPage('appointments');
        //             setTimeout(()=> {
        //                 document.getElementById('apptSearch').value = term;
        //                 renderAppointments(appointments,term);
        //             }, 120);
        //         }
        //     }
        // });

        // Keyboard shortcut for notifications (Alt+T)
        document.addEventListener('keydown', (e) => {
            if (e.altKey && (e.key === 't' || e.key === 'T')) {
                showToast('üîî You have ' + (appointments.filter(a => a.status !== 'confirmed').length) + ' pending appointments.');
            }
        });

        
        // Charts
        let charts = {};
        function initCharts(){
            if (charts.weight) { // update with latest data
                updateChartsData();
                return;
            }
            const chartOptions = {
                responsive:true, maintainAspectRatio:false,
                plugins: { legend:{ display:true, labels:{ font:{ size:12 } } } },
                scales: { y: { beginAtZero:false } },
            };

            const weightCtx = document.getElementById('weightChart')?.getContext('2d');
            const sugarCtx = document.getElementById('sugarChart')?.getContext('2d');
            const bpCtx = document.getElementById('bpChart')?.getContext('2d');
            const heartCtx = document.getElementById('heartChart')?.getContext('2d');

            const labels = vitals.map(v => new Date(v.ts).toLocaleDateString()).slice(-30);
            charts.weight = weightCtx && new Chart(weightCtx, {
                type:'line',
                data: {
                    labels,
                    datasets: [{
                        label:'Weight (kg)',
                        data: vitals.map(v=>v.weight).slice(-30),
                        borderColor:'#8b5cf6',
                        backgroundColor:'rgba(139,92,246,0.08)',
                        borderWidth:2, fill:true, tension:0.35, pointRadius:3
                    }]
                },
                options: chartOptions
            });

            charts.sugar = sugarCtx && new Chart(sugarCtx, {
                type:'line',
                data:{
                    labels,
                    datasets:[{
                        label:'Blood Sugar (mmol/L)',
                        data: vitals.map(v=>v.sugar).slice(-30),
                        borderColor:'#10b981',
                        backgroundColor:'rgba(16,185,129,0.08)',
                        borderWidth:2, fill:true, tension:0.35, pointRadius:3
                    }]
                },
                options: chartOptions
            });

            charts.heart = heartCtx && new Chart(heartCtx, {
                type:'line',
                data:{
                    labels,
                    datasets:[{
                        label:'Heart Rate (bpm)',
                        data: vitals.map(v=>v.heart).slice(-30),
                        borderColor:'#10b981',
                        backgroundColor:'rgba(255,185,50,0.08)',
                        borderWidth:2, fill:true, tension:0.35, pointRadius:3
                    }]
                },
                options: chartOptions
            });

            charts.bp = bpCtx && new Chart(bpCtx, {
                type:'line',
                data:{
                    labels,
                    datasets:[
                        { label:'Systolic (mmHg)', data: vitals.map(v=>v.sys).slice(-30), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.08)', borderWidth:2, fill:true, tension:0.35, pointRadius:3 },
                        { label:'Diastolic (mmHg)', data: vitals.map(v=>v.dia).slice(-30), borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.06)', borderWidth:2, fill:true, tension:0.35, pointRadius:3 }
                    ]
                },
                options: chartOptions
            });
        }

        function updateChartsData(){
            const labels = vitals.map(v => new Date(v.ts).toLocaleDateString()).slice(-30);
            if(charts.weight) { charts.weight.data.labels = labels; charts.weight.data.datasets[0].data = vitals.map(v=>v.weight).slice(-30); charts.weight.update(); }
            if(charts.sugar) { charts.sugar.data.labels = labels; charts.sugar.data.datasets[0].data = vitals.map(v=>v.sugar).slice(-30); charts.sugar.update(); }
            if(charts.bp) {
                charts.bp.data.labels = labels;
                charts.bp.data.datasets[0].data = vitals.map(v=>v.sys).slice(-30);
                charts.bp.data.datasets[1].data = vitals.map(v=>v.dia).slice(-30);
                charts.bp.update();
            }
        }

        // Auto-init charts when trends visible
        document.addEventListener('visibilitychange', ()=> {
            if(document.visibilityState === 'visible' && document.querySelector('#trends.active')) initCharts();
        });

        // initial call for page load if trends is default
        if(document.getElementById('trends').classList.contains('active')) setTimeout(initCharts,120);

        // Keep appointments and vitals rendering in sync
        (function initialRender(){
            renderAppointments();
            renderVitalsHistory();
            updateSummaryMetrics(vitals);
        })();

        // Provide small helpers to go to pages from dashboard buttons
        document.getElementById('gotoVitals').addEventListener('click', ()=> switchPage('vitals'));
        document.getElementById('gotoAppointments').addEventListener('click', ()=> switchPage('appointments'));
        document.getElementById('gotoTrends').addEventListener('click', ()=> switchPage('trends'));

        // If appointment form edit logic left form in edit mode, clean when modal closes
        document.getElementById('closeModal').addEventListener('click', () => { delete appointmentForm.dataset.editId; appointmentForm.reset(); });
        document.getElementById('cancelAppt').addEventListener('click', () => { delete appointmentForm.dataset.editId; appointmentForm.reset(); });

   

        // Simple autosave toggle indicator
        // document.getElementById('autosaveStatus').textContent = 'On';

        // Make navItem clicks accessible with keyboard previously done; ensure click focuses main content
        navItems.forEach(i => i.addEventListener('click', () => { document.getElementById('contentArea').focus && document.getElementById('contentArea').focus(); }));

        // Small protection to ensure charts always created after DOM ready
        window.addEventListener('load', ()=>{
            // when user switches to trends later, initChaerts will be called
            // but pre-init weight chart data for preview if needed
        });

      async  function deleteAccount() {
        if (!confirm("Are you sure you want to delete your account?\nThis action is irreversible")) {
            return
        }
             try {
        const response = await fetch(`/api/accounts/<%= id%>`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Delete failed');      
        if(response.ok){window.location.reload();}  
      } catch (error) {
        showToast('Failed to delete account.');
        console.error('Error deleting appointment:', error);
      }
            
        }

    </script>
    
</body>
</html>